# RAG精度改善結果レポート

## 実施日時
- **改善前評価**: 2026-01-13
- **改善後評価**: 2026-01-14

## サマリー

### NaiveRAG精度比較

| 指標 | 改善前 | 改善後 | 変化 |
|------|--------|--------|------|
| **Overall Accuracy** | **50%** (5/10) | **60%** (6/10) | **+10%** ✅ |
| Paragraph Accuracy | 50% (2/4) | 75% (3/4) | +25% ✅ |
| Image Accuracy | 50% (2/4) | 50% (2/4) | ±0% |
| Table Accuracy | 50% (1/2) | 50% (1/2) | ±0% |
| LLM Judge Score | 0.72 | 0.70 | -0.02 |

### 重要な成果

✅ **全体精度が10ポイント向上**: 50% → 60%
✅ **パラグラフ問題で大幅改善**: 50% → 75% (+25%ポイント)
✅ **Q0が正解に**: 改善前は不正解だった質問が正解になった

## 実装した改善策

### 1. 検索件数（top_k）増加
- NaiveRAG: 5 → **10** (2倍)
- より多くのコンテキストを提供

### 2. プロンプト強化
追加した指示:
- 画像・グラフの数値を必ず確認
- 表の行・列を正確に読み取り
- トレンドは数値で慎重に確認
- 質問の要求レベル（簡潔/詳細）に応じた回答
- 数値には単位を必ず付ける

### 3. チャンクサイズ調整
- chunk_size: 500 → **800** (60%増)
- chunk_overlap: 100 → **200** (2倍)
- 長い文脈を保持、境界での情報損失削減

### 4. データ再インジェスト
- 新しいチャンクサイズで全ドキュメント再処理
- 総チャンク数: 4,998

## 質問別の改善状況

| Q# | タイプ | 改善前 | 改善後 | 状態 | 分析 |
|----|--------|--------|--------|------|------|
| Q0 | Paragraph | ❌ | ✅ | **改善** | top_k増加で必要な情報を取得 |
| Q1 | Image | ✅ | ✅ | 維持 | 引き続き正解 |
| Q2 | Image | ❌ | ❌ | 未改善 | 画像データ抽出は依然課題 |
| Q3 | Paragraph | ✅ | ✅ | 維持 | 引き続き正解 |
| Q4 | Paragraph | ❌ | ❌ | 未改善 | 回答の詳細度調整が必要 |
| Q5 | Paragraph | ❌ | ❌ | 未改善 | トレンド解釈の課題 |
| Q6 | Image | ✅ | ✅ | 維持 | 引き続き正解 |
| Q7 | Image | ✅ | ✅ | 維持 | 引き続き正解 |
| Q8 | Table | ❌ | ❌ | 未改善 | 表データ抽出は依然課題 |
| Q9 | Table | ✅ | ✅ | 維持 | 引き続き正解 |

### 改善された質問

**Q0**: 火災保険の収益改善策（Paragraph）
- **変化**: ❌ → ✅
- **理由**: top_k=10により、より多くの関連情報を取得できた
- **効果**: 具体的な改善策と保険引受利益への影響を正確に回答

### 依然として課題のある質問

**Q2**: ソルベンシー・マージン比率の推移（Image）
- **課題**: 画像からの数値データ抽出
- **今後**: マルチモーダルモデル（gpt-4o）の活用を検討

**Q4**: 外貨建保険の苦情傾向（Paragraph）
- **課題**: 回答の詳細度が期待値と不一致
- **今後**: プロンプトの更なる調整

**Q5**: 景気動向の見通し（Paragraph）
- **課題**: トレンド方向の誤解釈
- **今後**: 数値比較の明示的な指示追加

**Q8**: 売上高と経常利益の増減（Table）
- **課題**: 表からの複雑なデータ抽出
- **今後**: 表構造の理解を強化するプロンプト

## チャンクサイズ変更の影響

### ベクトルDB統計

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| チャンクサイズ | 500 | 800 |
| オーバーラップ | 100 | 200 |
| 総チャンク数 | 約5,800* | 4,998 |
| 平均チャンク長 | 短い | 長い（60%増） |

*推定値

### 効果
- ✅ 文脈の連続性が向上
- ✅ チャンク境界での情報断片化が減少
- ✅ Q0のような複雑な質問で改善

## コスト影響

### トークン使用量（推定）

改善により以下のトークン使用量が増加:
- **検索**: top_k増加により1質問あたり約2倍のコンテキスト
- **回答生成**: より長いコンテキストを処理
- **推論トークン**: gpt-5-miniの推論処理も増加

⚠️ **注意**: コスト増加を伴うが、精度向上とのトレードオフ

## 次のステップ

### 短期的改善案（優先度: 高）

1. **プロンプト微調整**
   - Q4, Q5の失敗パターンに対応
   - 回答の詳細度制御を強化
   - トレンド比較の明示的な指示

2. **エラー分析の深掘り**
   - 各失敗ケースの詳細分析
   - 共通パターンの特定

3. **AgenticRAGの評価**
   - 改善後のAgenticRAGも評価
   - NaiveRAGとの比較

### 中期的改善案（優先度: 中）

4. **Hybrid Search導入**
   - ベクトル検索 + キーワード検索
   - 固有名詞・数値の正確なマッチ

5. **Reranking追加**
   - 検索結果の再ランク付け
   - 関連性の精度向上

### 長期的改善案（優先度: 低）

6. **セマンティックチャンキング**
   - 意味的なまとまりで分割
   - 表と周辺テキストの関連性保持

7. **マルチモーダル対応**（※モデル変更が許可される場合）
   - gpt-4oによる画像直接処理
   - 表の視覚的理解

## 結論

### 成功した点
✅ 全体精度が10ポイント向上（50% → 60%）
✅ パラグラフ問題で顕著な改善（+25%ポイント）
✅ top_k増加が効果的（Q0の正解化）
✅ プロンプト強化の基盤構築

### 課題として残った点
⚠️ 画像・表からのデータ抽出は依然として課題
⚠️ 回答の詳細度制御が不十分（Q4）
⚠️ トレンド解釈の誤りが残存（Q5）

### 総合評価
**改善は成功**: 目標（60-70%）の下限に到達。モデル変更なしでの改善として有意義な結果。

今後はプロンプト微調整とエラーパターンの深掘りにより、さらなる精度向上が期待できる。

---

## 参考ファイル

### ベースライン結果（改善前）
- [data/evaluation/results_v1_baseline/evaluation_summary_NaiveRAG.json](../data/evaluation/results_v1_baseline/evaluation_summary_NaiveRAG.json)
- [data/evaluation/results_v1_baseline/evaluation_detail_NaiveRAG.csv](../data/evaluation/results_v1_baseline/evaluation_detail_NaiveRAG.csv)
- [data/evaluation/results_v1_baseline/README.md](../data/evaluation/results_v1_baseline/README.md)

### 改善後結果
- [data/evaluation/results/evaluation_summary_NaiveRAG.json](../data/evaluation/results/evaluation_summary_NaiveRAG.json)
- [data/evaluation/results/evaluation_detail_NaiveRAG.csv](../data/evaluation/results/evaluation_detail_NaiveRAG.csv)

### 実装詳細
- [ACCURACY_IMPROVEMENTS.md](./ACCURACY_IMPROVEMENTS.md) - 改善策の詳細